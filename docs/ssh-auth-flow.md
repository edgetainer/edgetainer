# Zero-Touch SSH Authentication in Edgetainer

This document explains how SSH authentication works between the agent and server in Edgetainer, with a focus on the zero-touch provisioning flow.

## Overview

Edgetainer uses SSH for secure communication between agents (edge devices) and the management server. This connection enables:

1. Secure remote access to devices
2. Command execution on devices
3. Port forwarding for accessing services on devices

## Zero-Touch Provisioning Flow

1. **Provision Request:**
   - Admin requests a new device provisioning token via the API
   - Server generates a unique device ID and provisioning token
   - Server generates an SSH key pair specifically for this device
   - The public key is registered with the server (added to authorized_keys)
   - The token and device ID are returned to the admin

2. **Device Provisioning:**
   - Device boots with the Flatcar Linux Ignition URL pointing to the token endpoint
   - Device requests the Ignition configuration using the token
   - Server validates the token and returns the Ignition configuration
   - The Ignition configuration includes the device's private SSH key
   - Device applies the configuration, storing the private key securely

3. **Automatic Connection:**
   - The device container automatically starts and connects to the server
   - SSH authentication happens seamlessly using the pre-provisioned keys
   - No manual key registration is needed

## SSH Key Components

### Server Side
- **Server Host Key:** Generated on server startup, identifies the server to clients
- **Device Public Keys:** One for each device, stored in `/app/ssh/authorized_keys.d/`
- **Combined Authorized Keys:** File at `/app/ssh/authorized_keys`

### Device Side
- **Device Private Key:** Pre-provisioned via Ignition, stored at `/etc/ssh/id_rsa`
- **Server Host Key Verification:** Device verifies the server's identity on connection

## Authentication Flow

1. **Connection Establishment:**
   - Agent connects to the server using SSH with the pre-provisioned private key
   - Agent verifies the server's identity using the server's host key
   - Server authenticates the agent using the registered public key
   - Server identifies which device is connecting based on the key

2. **Access Control:**
   - Each agent's key is linked to a specific device ID (prefixed in authorized_keys)
   - The server can control what actions each device is allowed to perform
   - Multiple devices can connect simultaneously, each with its own secure connection

## Key Storage

- **Server Keys:** Stored in Docker volumes for persistence
  - Server host key: `edgetainer-server-ssh:/app/ssh/ssh_host_key`
  - Device keys: `edgetainer-server-ssh:/app/ssh/device_keys/<device-id>/`
  - Authorized keys: `edgetainer-server-ssh:/app/ssh/authorized_keys`

- **Device Keys:** 
  - Provisioned via Ignition configuration
  - Stored in the device's filesystem
  - Mounted into the agent container

## Advanced Provisioning

The server's provisioning endpoint generates a complete Ignition configuration that:

1. Installs the device's private SSH key
2. Sets up the hostname based on the device ID
3. Creates a systemd service to run the agent container
4. Configures the container with environment variables

## Security Considerations

- SSH keys provide strong cryptographic authentication
- Keys are generated by the server with proper entropy
- Each device has a unique key pair, not shared with other devices
- The device's private key never leaves the server until provisioning
- Each device has a unique identity, allowing granular access control
- All communication is encrypted using SSH
- No passwords or tokens to manage after initial provisioning
